<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Plastic Classification Demo</title>
  <!-- Add TensorFlow.js FIRST (required dependency) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <!-- Then Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; }
    .container { margin: 40px auto; max-width: 480px; background: #fff; padding: 24px; border-radius: 6px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);}
    #preview { width: 224px; height: 224px; object-fit: contain; border: 1px solid #ccc; margin-bottom: 16px;}
    #label-container { font-size: 1.3em; font-weight: bold; color: #2c7; margin: 20px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Plastic Classifier (Upload Test)</h1>
    <p>Upload an image to see the prediction below.</p>
    <input type="file" id="upload" accept="image/*">
    <br>
    <img id="preview" src="#" alt="Image preview" style="display:none;"/>
    <div id="label-container">Awaiting image uploadâ€¦</div>
  </div>
  <script type="text/javascript">
    const MODEL_URL = "https://ankurcodetesting.github.io/plastic-detector/model.json";

    let model;

    async function loadModel() {
      try {
        const tm = window.tmImage;
        model = await tm.load(MODEL_URL, MODEL_URL.replace("model.json", "metadata.json"));
        document.getElementById('label-container').textContent = "Model loaded. Upload an image!";
      } catch (error) {
        console.error("Error model not working:", error);
        document.getElementById('label-container').textContent = "Error in model. Check console.";
      }
    }
    loadModel();

    const upload = document.getElementById('upload');
    const preview = document.getElementById('preview');
    const labelContainer = document.getElementById('label-container');

    upload.addEventListener('change', async (evt) => {
      const file = evt.target.files[0];
      if (!file || !model) {
        labelContainer.textContent = "Model not loaded yet. Please wait.";
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = '';
        // Explicitly wait for image load before predicting
        preview.onload = async function() {
          await predictImage(preview);
        };
        // Trigger load if already complete
        if (preview.complete) {
          preview.onload();
        }
      };
      reader.readAsDataURL(file);
    });

    async function predictImage(imgElement) {
      labelContainer.textContent = "Predicting...";
      try {
        const prediction = await model.predict(imgElement);
        let results = prediction
          .map(p => `${p.className}: ${(p.probability * 100).toFixed(1)}%`)
          .join("<br>");
        labelContainer.innerHTML = results;
      } catch (error) {
        console.error("Error during prediction:", error);
        labelContainer.textContent = "Prediction failed. Check console.";
      }
    }
  </script>
</body>
</html>
